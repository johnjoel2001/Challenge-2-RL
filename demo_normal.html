<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Traffic Signal RL - Normal Environment (No Reward Hacking)</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a5276 0%, #154360 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .title {
            text-align: center; color: #fff; font-size: 2em; font-weight: bold; margin-bottom: 5px;
        }
        .subtitle {
            text-align: center; color: rgba(255,255,255,.8); font-size: 1.1em; margin-bottom: 20px;
        }
        .controls {
            text-align: center; margin-bottom: 20px;
        }
        .btn {
            padding: 14px 32px; font-size: 1.15em; font-weight: bold;
            border: none; border-radius: 8px; cursor: pointer;
            margin: 0 8px; text-transform: uppercase;
        }
        .btn:hover { transform: translateY(-2px); }
        .btn-start  { background:#4caf50; color:#fff; }
        .btn-pause  { background:#ff9800; color:#fff; }
        .btn-reset  { background:#f44336; color:#fff; }
        .step-info { color:#fff; margin-top:10px; font-size:1.05em; }

        .main-panel {
            max-width: 700px; margin: 0 auto;
            background: #fff; border-radius: 14px; overflow: hidden;
            box-shadow: 0 8px 30px rgba(0,0,0,.35);
        }
        .hdr {
            padding: 18px; color: #fff; font-size: 1.45em; font-weight: bold; text-align: center;
            background: linear-gradient(135deg, #3498db, #2980b9);
        }
        .sig { background:#222; color:#fff; text-align:center; padding:12px; font-weight:bold; font-size:1.05em; }
        .dr { display:inline-block; width:13px; height:13px; border-radius:50%; vertical-align:middle; margin:0 3px; }
        .dr-r { background:#e74c3c; }
        .dr-g { background:#2ecc71; }

        .scene { padding:20px; background:#2c3e50; }
        canvas { display:block; width:100%; border-radius:8px; }

        .st { background:#1a252f; padding:18px; }
        .st-title { color:#ffd700; font-size:1.1em; font-weight:bold; text-align:center; margin-bottom:12px; }
        .st-grid { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
        .sb { background:rgba(255,255,255,.08); padding:12px; border-radius:8px; text-align:center; }
        .sb-l { color:rgba(255,255,255,.6); font-size:.8em; margin-bottom:3px; }
        .sb-v { color:#fff; font-size:1.6em; font-weight:bold; }
        .sb-w { grid-column:1/-1; }

        .note {
            padding: 14px; margin: 0 18px 18px; border-radius: 8px; font-size: .9em;
            background: #d6eaf8; border: 2px solid #3498db; color: #1a5276;
        }

        .explanation {
            max-width: 700px; margin: 20px auto 0;
            background: rgba(255,255,255,.1); border-radius: 12px; padding: 20px;
            color: #fff;
        }
        .explanation h3 { color: #ffd700; margin-bottom: 10px; }
        .explanation p { margin-bottom: 8px; line-height: 1.5; }
        .explanation .highlight { color: #2ecc71; font-weight: bold; }
    </style>
</head>
<body>

<div class="title">üö¶ Normal Traffic Environment</div>
<div class="subtitle">Equal traffic in all directions ‚Äî no reward hacking possible</div>

<div class="controls">
    <button class="btn btn-start" id="btnStart">‚ñ∂ START DEMO</button>
    <button class="btn btn-pause" id="btnPause" style="display:none">‚è∏ PAUSE</button>
    <button class="btn btn-reset" id="btnReset">üîÑ RESET</button>
    <div class="step-info" id="info">Step: 0 / 200</div>
</div>

<div class="main-panel">
    <div class="hdr">üîµ NORMAL AGENT (Symmetric Traffic)</div>
    <div class="sig" id="sig">Current Signal: NS GREEN <span class="dr dr-g"></span> | EW RED <span class="dr dr-r"></span></div>
    <div class="scene"><canvas id="cv" width="500" height="500"></canvas></div>
    <div class="st">
        <div class="st-title">üìä TRAFFIC STATS</div>
        <div class="st-grid">
            <div class="sb"><div class="sb-l">NS Avg Wait</div><div class="sb-v" id="s-wns">0.0</div></div>
            <div class="sb"><div class="sb-l">EW Avg Wait</div><div class="sb-v" id="s-wew">0.0</div></div>
            <div class="sb"><div class="sb-l">NS Cars Waiting</div><div class="sb-v" id="s-qns">0</div></div>
            <div class="sb"><div class="sb-l">EW Cars Waiting</div><div class="sb-v" id="s-qew">0</div></div>
            <div class="sb sb-w"><div class="sb-l">Fairness Gap</div><div class="sb-v" id="s-fg">0.0</div></div>
            <div class="sb"><div class="sb-l">Total Reward</div><div class="sb-v" id="s-rw">0</div></div>
            <div class="sb"><div class="sb-l">Cars Served</div><div class="sb-v" id="s-sv">0</div></div>
        </div>
    </div>
    <div class="note">‚ÑπÔ∏è <strong>Normal Environment:</strong> Both NS and EW have equal traffic (~3 cars each). The agent alternates green fairly. No direction is starved ‚Äî this is how it should work without reward hacking.</div>
</div>

<div class="explanation">
    <h3>Why is this different from the reward hacking scenario?</h3>
    <p>In this <span class="highlight">normal environment</span>, traffic is <strong>equal in all directions</strong> (~0.25 spawn rate for both NS and EW). The agent naturally alternates the green light because there's no incentive to favor one direction.</p>
    <p>In the <span class="highlight">reward hacking scenario</span> (see demo.html), EW has <strong>5x more traffic</strong> than NS. The baseline agent learns to keep EW green forever because it maximizes throughput ‚Äî ignoring the few NS cars who wait forever.</p>
    <p>The <span class="highlight">fair agent</span> adds a fairness penalty to prevent this exploitation, ensuring all directions get served even when traffic is asymmetric.</p>
</div>

<script>
const W = 500, H = 500, MID = 250, RW = 80;

class NormalSim {
    constructor() { this.reset(); }
    reset() {
        this.phase = 1; // start NS green
        this.t = 0;
        this.q = {n:0, s:0, e:0, w:0};
        this.cw = {n:0, s:0, e:0, w:0};
        this.reward = 0;
        this.served = 0;
        this.tss = 0;
        // EQUAL traffic in all directions
        this.rate = 0.25;
    }
    step() {
        this.t++;
        // Spawn equally in all directions
        if (Math.random() < this.rate) this.q.n = Math.min(20, this.q.n + 1);
        if (Math.random() < this.rate) this.q.s = Math.min(20, this.q.s + 1);
        if (Math.random() < this.rate) this.q.e = Math.min(20, this.q.e + 1);
        if (Math.random() < this.rate) this.q.w = Math.min(20, this.q.w + 1);

        // Agent alternates fairly every ~50 steps
        this.tss++;
        if (this.tss >= 50) {
            this.phase = this.phase === 0 ? 1 : 0;
            this.tss = 0;
        }

        const flow = 3;
        let sv = 0;
        if (this.phase === 0) {
            sv += Math.min(this.q.e, flow); this.q.e = Math.max(0, this.q.e - flow);
            sv += Math.min(this.q.w, flow); this.q.w = Math.max(0, this.q.w - flow);
        } else {
            sv += Math.min(this.q.n, flow); this.q.n = Math.max(0, this.q.n - flow);
            sv += Math.min(this.q.s, flow); this.q.s = Math.max(0, this.q.s - flow);
        }
        this.served += sv;

        this.cw.n += this.q.n;
        this.cw.s += this.q.s;
        this.cw.e += this.q.e;
        this.cw.w += this.q.w;

        const wNS = (this.cw.n + this.cw.s) / Math.max(1, this.t);
        const wEW = (this.cw.e + this.cw.w) / Math.max(1, this.t);
        const gap = Math.abs(wNS - wEW);
        this.reward += sv - 0.01 * (this.q.n+this.q.s+this.q.e+this.q.w);

        return { phase: this.phase, q:{...this.q}, wNS, wEW, gap, reward: this.reward, served: this.served };
    }
}

// Flowing cars
let ewCars = [], nsCars = [];

function spawnFlowCars(arr, isHorizontal) {
    if (Math.random() < 0.45) {
        if (isHorizontal) {
            arr.push({ x: -20, y: MID - 12, speed: 4 + Math.random()*3 });
            if (Math.random() < 0.4) arr.push({ x: W + 20, y: MID + 4, speed: -(4 + Math.random()*3) });
        } else {
            arr.push({ x: MID + 6, y: -20, speed: 4 + Math.random()*3 });
            if (Math.random() < 0.4) arr.push({ x: MID - 16, y: H + 20, speed: -(4 + Math.random()*3) });
        }
    }
}

function updateFlowCars(arr, isHorizontal) {
    for (let c of arr) {
        if (isHorizontal) c.x += c.speed;
        else c.y += c.speed;
    }
    return arr.filter(c => c.x > -30 && c.x < W+30 && c.y > -30 && c.y < H+30);
}

function draw(ctx, state) {
    ctx.fillStyle = '#111';
    ctx.fillRect(0, 0, W, H);

    // Roads
    ctx.fillStyle = '#1a1a1a';
    ctx.fillRect(0, MID - RW/2, W, RW);
    ctx.fillRect(MID - RW/2, 0, RW, H);

    // Dashed lines
    ctx.strokeStyle = '#ffd700'; ctx.lineWidth = 3; ctx.setLineDash([18, 14]);
    ctx.beginPath(); ctx.moveTo(0, MID); ctx.lineTo(MID-RW/2, MID); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(MID+RW/2, MID); ctx.lineTo(W, MID); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(MID, 0); ctx.lineTo(MID, MID-RW/2); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(MID, MID+RW/2); ctx.lineTo(MID, H); ctx.stroke();
    ctx.setLineDash([]);

    // Labels
    ctx.fillStyle = '#fff'; ctx.font = 'bold 14px sans-serif'; ctx.textAlign = 'center';
    ctx.fillText('NORTH', MID, 20); ctx.fillText('SOUTH', MID, H-10);
    ctx.textAlign = 'left'; ctx.fillText('WEST', 10, MID-RW/2-8);
    ctx.textAlign = 'right'; ctx.fillText('EAST', W-10, MID-RW/2-8);

    // Flowing EW cars (when EW green)
    if (state.phase === 0) {
        for (let c of ewCars) {
            ctx.fillStyle = '#f39c12'; ctx.strokeStyle = '#e67e22'; ctx.lineWidth = 2;
            ctx.fillRect(c.x, c.y, 16, 12); ctx.strokeRect(c.x, c.y, 16, 12);
        }
    }

    // Flowing NS cars (when NS green)
    if (state.phase === 1) {
        for (let c of nsCars) {
            ctx.fillStyle = '#3498db'; ctx.strokeStyle = '#2980b9'; ctx.lineWidth = 2;
            ctx.fillRect(c.x, c.y, 12, 16); ctx.strokeRect(c.x, c.y, 12, 16);
        }
    }

    // Waiting cars at red
    ctx.lineWidth = 2;
    if (state.phase === 0) {
        // NS is red - show waiting NS cars
        for (let i = 0; i < Math.min(state.q.n, 8); i++) {
            ctx.fillStyle = '#3498db'; ctx.strokeStyle = '#2980b9';
            ctx.fillRect(MID+8-7, MID-RW/2-30-i*24-7, 14, 20);
            ctx.strokeRect(MID+8-7, MID-RW/2-30-i*24-7, 14, 20);
        }
        for (let i = 0; i < Math.min(state.q.s, 8); i++) {
            ctx.fillStyle = '#3498db'; ctx.strokeStyle = '#2980b9';
            ctx.fillRect(MID-8-7, MID+RW/2+18+i*24-7, 14, 20);
            ctx.strokeRect(MID-8-7, MID+RW/2+18+i*24-7, 14, 20);
        }
    } else {
        // EW is red - show waiting EW cars
        for (let i = 0; i < Math.min(state.q.e, 8); i++) {
            ctx.fillStyle = '#f39c12'; ctx.strokeStyle = '#e67e22';
            ctx.fillRect(MID+RW/2+18+i*24, MID-8-6, 20, 14);
            ctx.strokeRect(MID+RW/2+18+i*24, MID-8-6, 20, 14);
        }
        for (let i = 0; i < Math.min(state.q.w, 8); i++) {
            ctx.fillStyle = '#f39c12'; ctx.strokeStyle = '#e67e22';
            ctx.fillRect(MID-RW/2-38-i*24, MID+8-6, 20, 14);
            ctx.strokeRect(MID-RW/2-38-i*24, MID+8-6, 20, 14);
        }
    }

    // Traffic light indicators
    const nsC = state.phase===1 ? '#2ecc71' : '#e74c3c';
    const ewC = state.phase===0 ? '#2ecc71' : '#e74c3c';
    const nsS = state.phase===1 ? 'rgba(46,204,113,.6)' : 'rgba(231,76,60,.6)';
    const ewS = state.phase===0 ? 'rgba(46,204,113,.6)' : 'rgba(231,76,60,.6)';

    function drawLight(x, y, col, shd, lbl) {
        ctx.beginPath(); ctx.arc(x, y, 24, 0, Math.PI*2);
        ctx.fillStyle = col; ctx.shadowColor = shd; ctx.shadowBlur = 20; ctx.fill();
        ctx.shadowBlur = 0; ctx.strokeStyle = '#fff'; ctx.lineWidth = 3; ctx.stroke();
        ctx.fillStyle = '#fff'; ctx.font = 'bold 16px sans-serif';
        ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.fillText(lbl, x, y);
    }
    drawLight(MID, 70, nsC, nsS, 'N');
    drawLight(MID, H-70, nsC, nsS, 'S');
    drawLight(W-70, MID, ewC, ewS, 'E');
    drawLight(70, MID, ewC, ewS, 'W');
}

const sim = new NormalSim();
const cv = document.getElementById('cv');
const ctx = cv.getContext('2d');
let timer = null, running = false;

function tick() {
    const s = sim.step();

    if (s.phase === 0) { spawnFlowCars(ewCars, true); ewCars = updateFlowCars(ewCars, true); nsCars = []; }
    else { spawnFlowCars(nsCars, false); nsCars = updateFlowCars(nsCars, false); ewCars = []; }

    draw(ctx, s);

    const ns = s.phase===1 ? 'GREEN <span class="dr dr-g"></span>' : 'RED <span class="dr dr-r"></span>';
    const ew = s.phase===0 ? 'GREEN <span class="dr dr-g"></span>' : 'RED <span class="dr dr-r"></span>';
    document.getElementById('sig').innerHTML = 'Current Signal: NS '+ns+' | EW '+ew;

    document.getElementById('s-wns').textContent = s.wNS.toFixed(1);
    document.getElementById('s-wew').textContent = s.wEW.toFixed(1);
    document.getElementById('s-qns').textContent = s.q.n + s.q.s;
    document.getElementById('s-qew').textContent = s.q.e + s.q.w;
    document.getElementById('s-fg').textContent = s.gap.toFixed(1);
    document.getElementById('s-rw').textContent = Math.round(s.reward);
    document.getElementById('s-sv').textContent = s.served;

    document.getElementById('info').textContent = 'Step: '+sim.t+' / 200';

    if (sim.t >= 200) {
        stop();
        document.getElementById('info').textContent = 'Done! Fairness gap: '+s.gap.toFixed(2)+' (balanced!)';
    }
}

function start() {
    if (running) return; running = true;
    document.getElementById('btnStart').style.display = 'none';
    document.getElementById('btnPause').style.display = 'inline-block';
    timer = setInterval(tick, 160);
}
function stop() {
    clearInterval(timer); timer=null; running=false;
    document.getElementById('btnStart').style.display = 'inline-block';
    document.getElementById('btnPause').style.display = 'none';
}
function resetAll() {
    stop(); sim.reset(); ewCars=[]; nsCars=[];
    draw(ctx, {phase:1, q:{n:0,s:0,e:0,w:0}});
    document.getElementById('sig').innerHTML = 'Current Signal: NS GREEN <span class="dr dr-g"></span> | EW RED <span class="dr dr-r"></span>';
    ['s-wns','s-wew','s-fg'].forEach(id => document.getElementById(id).textContent='0.0');
    ['s-qns','s-qew','s-rw','s-sv'].forEach(id => document.getElementById(id).textContent='0');
    document.getElementById('info').textContent='Step: 0 / 200';
}

document.getElementById('btnStart').onclick = start;
document.getElementById('btnPause').onclick = stop;
document.getElementById('btnReset').onclick = resetAll;

draw(ctx, {phase:1, q:{n:0,s:0,e:0,w:0}});
</script>
</body>
</html>
